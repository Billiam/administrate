# Exit if any subcommand fails
set -e

VERSION=$(ruby -r ./lib/administrate/version.rb -e "puts Administrate::VERSION")
echo "building gem"
gem build administrate.gemspec
echo "installing gem package"
gem install administrate-$VERSION.gem

echo "using the new version of administrate in our Gemfile"
sed -i.bak "s/^gemspec$/gem \"administrate\", \"$VERSION\"/" Gemfile
rm Gemfile.bak
echo "bundling"
bundle check || bundle install
appraisal install

echo "running rake"
bundle exec rake
echo "running appraisals"
bundle exec appraisal rake

echo "uninstalling"
gem uninstall administrate -v $VERSION
echo "pushing"
gem push administrate-$VERSION.gem

bundle
bundle exec rake
bundle exec appraisal rake

echo "Administrate version $VERSION was released successfully."

git tag v$VERSION
git push --tags
